

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>techminer2.techminer.tools.import_scopus_files &mdash; TechMiner2 0.1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/jquery.js"></script>
        <script src="../../../../_static/underscore.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/clipboard.min.js"></script>
        <script src="../../../../_static/copybutton.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> TechMiner2
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Introduction</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/release_info.html">Release Information</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../introduction/license.html">MIT License</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Software comparison</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../techminer/__index__.html">TechMiner</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../bibliometrix/__index__.html">Bibliometrix</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../vantagepoint/__index__.html">VantagePoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../tlab/__index__.html">T-LAB</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../scientopy/__index__.html">ScientoPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">TechMiner2</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>techminer2.techminer.tools.import_scopus_files</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for techminer2.techminer.tools.import_scopus_files</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Import Scopus Files</span>
<span class="sd">===============================================================================</span>

<span class="sd">Import a scopus file to a working directory.</span>


<span class="sd">&gt;&gt;&gt; directory = &quot;data/regtech/&quot;</span>


<span class="sd">&gt;&gt;&gt; directory = &quot;data/dyna/&quot;</span>

<span class="sd">&gt;&gt;&gt; from techminer2 import techminer</span>
<span class="sd">&gt;&gt;&gt; techminer.tools.import_scopus_files(</span>
<span class="sd">...     directory, </span>
<span class="sd">...     disable_progress_bar=True,</span>
<span class="sd">... )</span>
<span class="sd">--INFO-- Concatenating raw files in data/regtech/raw/cited_by/</span>
<span class="sd">--INFO-- Concatenating raw files in data/regtech/raw/references/</span>
<span class="sd">--INFO-- Concatenating raw files in data/regtech/raw/documents/</span>
<span class="sd">--INFO-- Applying scopus tags to database files</span>
<span class="sd">--INFO-- Formating column names in database files</span>
<span class="sd">--INFO-- Dropping NA columns in database files</span>
<span class="sd">--INFO-- Removing accents in database files</span>
<span class="sd">--INFO-- Removing stranger chars in database files</span>
<span class="sd">--INFO-- Processing `abstract` column</span>
<span class="sd">--INFO-- Processing `authors_id` column</span>
<span class="sd">--INFO-- Processing `title` column</span>
<span class="sd">--INFO-- Processing `document_type` column</span>
<span class="sd">--INFO-- Processing `doi` column</span>
<span class="sd">--INFO-- Processing `eissn` column</span>
<span class="sd">--INFO-- Processing `global_citations` column</span>
<span class="sd">--INFO-- Processing `isbn` column</span>
<span class="sd">--INFO-- Processing `issn` column</span>
<span class="sd">--INFO-- Processing `raw_authors` column</span>
<span class="sd">--INFO-- Processing `source_abbr` column</span>
<span class="sd">--INFO-- Processing `source_name` column</span>
<span class="sd">--INFO-- Processing `global_references` column</span>
<span class="sd">--INFO-- Creating `authors` column</span>
<span class="sd">--INFO-- Creating `num_authors` column</span>
<span class="sd">--INFO-- Creating `article` column</span>
<span class="sd">--INFO-- Processing `raw_author_keywords` column</span>
<span class="sd">--INFO-- Processing `raw_index_keywords` column</span>
<span class="sd">--INFO-- Processing `raw_keywords` column</span>
<span class="sd">--INFO-- Creating `raw_abstract_words` column in data/regtech/processed/_documents.csv</span>
<span class="sd">--INFO-- Creating `raw_abstract_words` column in data/regtech/processed/_cited_by.csv</span>
<span class="sd">--INFO-- Creating `raw_title_words` column in data/regtech/processed/_documents.csv</span>
<span class="sd">--INFO-- Creating `raw_title_words` column in data/regtech/processed/_references.csv</span>
<span class="sd">--INFO-- Creating `raw_title_words` column in data/regtech/processed/_cited_by.csv</span>
<span class="sd">--INFO-- Creating `raw_words` column</span>
<span class="sd">--INFO-- Creating `keywords.txt` from author/index keywords, and abstract/title words</span>
<span class="sd">--INFO-- Applying `keywords.txt` thesaurus to author/index keywords and abstract/title words</span>
<span class="sd">--INFO-- The data/regtech/processed/countries.txt thesaurus file was created</span>
<span class="sd">--INFO-- The data/regtech/processed/countries.txt thesaurus file was applied to affiliations in all databases</span>
<span class="sd">--INFO-- Creating `num_global_references` column</span>
<span class="sd">--INFO-- Complete `source_abbr` column</span>
<span class="sd">--INFO-- Creating `abstract.csv` file from `documents` database</span>
<span class="sd">--INFO-- Creating `bradford` column</span>
<span class="sd">--INFO-- Searching `references` using DOI</span>
<span class="sd">--INFO-- Searching `references` using (year, title, author)</span>
<span class="sd">--INFO-- Searching `references` using (title)</span>
<span class="sd">--INFO-- Creating `local_citations` column in references database</span>
<span class="sd">--INFO-- Creating `local_citations` column in documents database</span>
<span class="sd">--INFO-- The data/regtech/processed/organizations.txt thesaurus file was created</span>
<span class="sd">--INFO-- The data/regtech/processed/organizations.txt thesaurus file was applied to affiliations in all databases</span>
<span class="sd">--INFO-- Process finished!!!</span>
<span class="sd">--INFO-- data/regtech/processed/_documents.csv: 52 imported records</span>
<span class="sd">--INFO-- data/regtech/processed/_references.csv: 909 imported records</span>
<span class="sd">--INFO-- data/regtech/processed/_cited_by.csv: 388 imported records</span>

<span class="sd"> </span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">os.path</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">nltk.stem</span> <span class="kn">import</span> <span class="n">PorterStemmer</span>
<span class="kn">from</span> <span class="nn">nltk.tokenize</span> <span class="kn">import</span> <span class="n">sent_tokenize</span>
<span class="kn">from</span> <span class="nn">textblob</span> <span class="kn">import</span> <span class="n">TextBlob</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">...</span> <span class="kn">import</span> <span class="n">vantagepoint</span>


<div class="viewcode-block" id="import_scopus_files"><a class="viewcode-back" href="../../../../techminer/tools/import_scopus_files.html#techminer2.techminer.tools.import_scopus_files.import_scopus_files">[docs]</a><span class="k">def</span> <span class="nf">import_scopus_files</span><span class="p">(</span>
    <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;./&quot;</span><span class="p">,</span>
    <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="o">**</span><span class="n">document_types</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Import Scopus files.&quot;&quot;&quot;</span>

    <span class="n">_create_working_directories</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_create_ignore_file</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_create_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_apply_scopus2tags_to_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_format_columns_names_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_remove_selected_document_types_from_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="o">**</span><span class="n">document_types</span><span class="p">)</span>
    <span class="n">_drop_na_columns_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_remove_accents_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_remove_stranger_chars_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_remove_anonymous_authors</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_repair_authors_id</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_process__abstract__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__authors_id__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__title__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__document_type__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__doi__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__eissn__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__global_citations__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__isbn__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__issn__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__raw_authors__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__source_abbr__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__source_name__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__global_references__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_create__authors__column</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>
    <span class="n">_create__num_authors__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_create__article__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Keywords: --------------------------------------------------------------</span>
    <span class="n">_process__raw_author_keywords__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__raw_index_keywords__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_process__raw_keywords__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_create_extract_raw_words_from_column</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">,</span> <span class="n">source_column</span><span class="o">=</span><span class="s2">&quot;abstract&quot;</span><span class="p">,</span> <span class="n">dest_column</span><span class="o">=</span><span class="s2">&quot;raw_abstract_words&quot;</span>
    <span class="p">)</span>
    <span class="n">_create_extract_raw_words_from_column</span><span class="p">(</span>
        <span class="n">directory</span><span class="p">,</span> <span class="n">source_column</span><span class="o">=</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">dest_column</span><span class="o">=</span><span class="s2">&quot;raw_title_words&quot;</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_create__raw_words__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">vantagepoint</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="n">create_keywords_thesaurus</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">vantagepoint</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="n">clean_keywords</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># -------------------------------------------------------------------------</span>
    <span class="n">vantagepoint</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="n">create_countries_thesaurus</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">vantagepoint</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="n">clean_countries</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_create__num_global_references__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_complete__source_abbr__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_create__abstract_csv__file</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">_create__bradford__column</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># WoS References ----------------------------------------------------------</span>
    <span class="n">_create_references</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>
    <span class="n">_create__local_citations__column_in_references_database</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">_create__local_citations__column_in_documents_database</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Organizations ------------------------------------------------------------</span>
    <span class="n">vantagepoint</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="n">create_organizations_thesaurus</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>
    <span class="n">vantagepoint</span><span class="o">.</span><span class="n">refine</span><span class="o">.</span><span class="n">clean_organizations</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">directory</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Process finished!!!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">_report_records</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_repair_authors_id</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Repairing authors ID</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="n">lenghts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">ids</span> <span class="o">=</span> <span class="n">ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span>
        <span class="n">lenghts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ids</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="n">max_length</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">lenghts</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;;&quot;</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="n">max_length</span><span class="p">,</span> <span class="s2">&quot;0&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_anonymous_authors</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Removing anonymous authors</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">!=</span> <span class="s2">&quot;Anon&quot;</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">!=</span> <span class="s2">&quot;[No author name available]&quot;</span><span class="p">]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_report_records</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="si">}</span><span class="s2"> imported records</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_selected_document_types_from_documents</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="o">**</span><span class="n">document_types</span><span class="p">):</span>

    <span class="n">discarded_document_types</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">document_types</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">False</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">discarded_document_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s2">&quot;--INFO-- Removing selected document types in documents database</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">document_type</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">discarded_document_types</span><span class="p">)]</span>
        <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_documents.csv&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>

    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_extract_raw_words_from_column</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">source_column</span><span class="p">,</span> <span class="n">dest_column</span><span class="p">):</span>

    <span class="n">roots</span> <span class="o">=</span> <span class="n">_extract_keywords_roots_from_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">source_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Creating `</span><span class="si">{</span><span class="n">dest_column</span><span class="si">}</span><span class="s2">` column in </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">source_column</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="n">text</span><span class="p">[</span><span class="n">source_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">source_column</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">source_column</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">TextBlob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">noun_phrases</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;raw_words&quot;</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;keys&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="n">text</span><span class="p">[</span><span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>

        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="p">[[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_words&quot;</span><span class="p">]]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span>
        <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">text</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>

        <span class="c1"># convert the pandas series to a dictionary</span>
        <span class="n">values_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">article</span><span class="p">,</span> <span class="n">text</span><span class="o">.</span><span class="n">raw_words</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="n">dest_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">values_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create__raw_words__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `raw_words` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;raw_author_keywords&quot;</span><span class="p">,</span>
            <span class="s2">&quot;raw_index_keywords&quot;</span><span class="p">,</span>
            <span class="s2">&quot;raw_abstract_words&quot;</span><span class="p">,</span>
            <span class="s2">&quot;raw_title_words&quot;</span><span class="p">,</span>
        <span class="p">]:</span>

            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>

                <span class="n">text</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">]</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">)</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">text</span>

        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">y</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">y</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_words&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create__local_citations__column_in_documents_database</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s2">&quot;--INFO-- Creating `local_citations` column in documents database</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># counts the number of citations for each local reference</span>
    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_documents.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">local_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">values_dict</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># assigns the number of citations to each document in documents database</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">article</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">values_dict</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># saves the new column in the references database</span>
    <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create__local_citations__column_in_references_database</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">references_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_references.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">references_path</span><span class="p">):</span>
        <span class="k">return</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s2">&quot;--INFO-- Creating `local_citations` column in references database</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="c1"># counts the number of citations for each local reference</span>
    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_documents.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">local_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">local_references</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">values_dict</span> <span class="o">=</span> <span class="n">local_references</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

    <span class="c1"># assigns the number of citations to each reference in references database</span>

    <span class="n">references</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">references_path</span><span class="p">)</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span><span class="o">.</span><span class="n">article</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">values_dict</span><span class="p">)</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="s2">&quot;local_citations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># saves the new column in the references database</span>
    <span class="n">references</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">references_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_references</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">references_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_references.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">references_path</span><span class="p">):</span>
        <span class="n">_create_referneces_from_references_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_create_references_from_documents_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_references_from_documents_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating references from  `documents.csv` file.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_documents.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>

    <span class="c1"># references como aparecen en los articulos</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># record in document.csv ---&gt; reference</span>
    <span class="n">thesaurus</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

    <span class="c1"># references = pd.read_csv(references_path)</span>

    <span class="c1"># marcador para indicar si la referencia fue encontrada</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># busqueda por doi</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using DOI</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">doi</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span><span class="p">,</span> <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span> <span class="o">==</span> <span class="n">doi</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de búsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por (año, autor y tttulo)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (year, title, author)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">authors</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">authors</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">authors</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[:</span><span class="mi">29</span><span class="p">]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[</span><span class="o">-</span><span class="mi">29</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de búsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por titulo</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (title)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                    <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                    <span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Crea la columna de referencias locales</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_referneces_from_references_csv_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">references_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_references.csv&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">references_path</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--WARN-- The  file </span><span class="si">{</span><span class="n">references_path</span><span class="si">}</span><span class="s2"> does not exists.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--WARN-- Some functionalities are disabled.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="n">references</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">references_path</span><span class="p">)</span>

    <span class="n">documents_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_documents.csv&quot;</span><span class="p">)</span>
    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">)</span>

    <span class="c1"># references como aparecen en los articulos</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">raw_cited_references</span> <span class="o">=</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># raw_cited_reference --&gt; article</span>
    <span class="n">thesaurus</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">raw_cited_references</span><span class="o">.</span><span class="n">tolist</span><span class="p">()}</span>

    <span class="c1"># marcador para indicar si la referencia fue encontrada</span>
    <span class="n">references</span><span class="p">[</span><span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># busqueda por doi</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using DOI</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">doi</span><span class="p">,</span> <span class="n">article</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span><span class="p">,</span> <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">doi</span><span class="p">)</span> <span class="ow">and</span> <span class="n">doi</span> <span class="ow">in</span> <span class="n">key</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">doi</span> <span class="o">==</span> <span class="n">doi</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de búsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por (año, autor y tttulo)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (year, title, author)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>

        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">year</span><span class="p">,</span> <span class="n">authors</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">authors</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">authors</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">title</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">year</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span>
            <span class="n">author</span> <span class="o">=</span> <span class="n">authors</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>

                    <span class="k">if</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[:</span><span class="mi">29</span><span class="p">]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">elif</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span> <span class="ow">in</span> <span class="n">text</span> <span class="ow">and</span> <span class="n">title</span><span class="p">[</span><span class="o">-</span><span class="mi">29</span><span class="p">:]</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Reduce la base de búsqueda</span>
    <span class="n">references</span> <span class="o">=</span> <span class="n">references</span><span class="p">[</span><span class="o">~</span><span class="n">references</span><span class="o">.</span><span class="n">found</span><span class="p">]</span>

    <span class="c1"># Busqueda por titulo</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Searching `references` using (title)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">references</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="n">disable_progress_bar</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">article</span><span class="p">,</span> <span class="n">title</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
            <span class="n">references</span><span class="o">.</span><span class="n">article</span><span class="p">,</span>
            <span class="n">references</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>

                <span class="n">title</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">title</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                    <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">thesaurus</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">key</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
                        <span class="n">thesaurus</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">article</span>
                        <span class="n">references</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">references</span><span class="o">.</span><span class="n">article</span> <span class="o">==</span> <span class="n">article</span><span class="p">,</span> <span class="s2">&quot;found&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1">#</span>
    <span class="c1"># Crea la columna de referencias locales</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">thesaurus</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">x</span> <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
    <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[</span><span class="s2">&quot;local_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="n">x</span>
    <span class="p">)</span>
    <span class="c1">#</span>
    <span class="n">documents</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">documents_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># def _create__author_year_source__column(directory):</span>
<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `author_year_source` column\n&quot;)</span>
<span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
<span class="c1">#     for file in files:</span>
<span class="c1">#         data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>
<span class="c1">#         #</span>
<span class="c1">#         name = data.authors.map(</span>
<span class="c1">#             lambda x: x.split(&quot;; &quot;)[0].strip() if not pd.isna(x) else &quot;[Anonymous]&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#         name += &quot; &quot; + data.year.map(str)</span>
<span class="c1">#         name += &quot; &quot; + data.source_abbr</span>
<span class="c1">#         #</span>
<span class="c1">#         data[&quot;author_year_source&quot;] = name.copy()</span>
<span class="c1">#         #</span>
<span class="c1">#         # TODO: assertion fails!!!</span>
<span class="c1">#         # assert len(data[&quot;author_year_source&quot;]) == len(</span>
<span class="c1">#         #     data[&quot;author_year_source&quot;].drop_duplicates()</span>
<span class="c1">#         # )</span>
<span class="c1">#         #</span>
<span class="c1">#         data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>


<span class="k">def</span> <span class="nf">_create__article__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="c1"># First Author, year, source_abbr, &#39;V&#39;volumne, &#39;P&#39;page_start, &#39; DOI &#39; doi</span>
    <span class="c1">#</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `article` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">wos_ref</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;[Anonymous]&quot;</span>
        <span class="p">)</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">volume</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, V&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">wos_ref</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">page_start</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;, P&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">isna</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="p">)</span>
        <span class="c1"># wos_ref += data.doi.map(lambda x: &quot;, DOI &quot; + str(x) if not pd.isna(x) else &quot;&quot;)</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wos_ref</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;article&quot;</span><span class="p">])</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># def _create_references_by_document_file(directory, disable_progress_bar=False):</span>

<span class="c1">#     file_name = os.path.join(directory, &quot;processed&quot;, &quot;_references.csv&quot;)</span>
<span class="c1">#     if not os.path.exists(file_name):</span>
<span class="c1">#         return</span>

<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `references_by_document.csv` file\n&quot;)</span>

<span class="c1">#     references = pd.read_csv(os.path.join(directory, &quot;processed&quot;, &quot;_references.csv&quot;))</span>
<span class="c1">#     references = references.assign(authors=references.authors.str.lower())</span>

<span class="c1">#     documents = pd.read_csv(os.path.join(directory, &quot;processed&quot;, &quot;_documents.csv&quot;))</span>

<span class="c1">#     # builds a table with:</span>
<span class="c1">#     #   record_no  raw_reference</span>
<span class="c1">#     #   ------------------------------------------------</span>
<span class="c1">#     reference_by_record = documents[[&quot;record_no&quot;, &quot;global_references&quot;]].copy()</span>

<span class="c1">#     reference_by_record = reference_by_record.rename(</span>
<span class="c1">#         columns={&quot;global_references&quot;: &quot;raw_reference&quot;}</span>
<span class="c1">#     )</span>
<span class="c1">#     reference_by_record = reference_by_record.dropna()</span>
<span class="c1">#     reference_by_record = reference_by_record.assign(</span>
<span class="c1">#         raw_reference=reference_by_record.raw_reference.str.split(&quot;;&quot;)</span>
<span class="c1">#     )</span>
<span class="c1">#     reference_by_record = reference_by_record.explode(&quot;raw_reference&quot;)</span>
<span class="c1">#     reference_by_record = reference_by_record.assign(</span>
<span class="c1">#         raw_reference=reference_by_record.raw_reference.str.strip()</span>
<span class="c1">#     )</span>
<span class="c1">#     reference_by_record = reference_by_record.assign(</span>
<span class="c1">#         raw_reference=reference_by_record.raw_reference.str.lower()</span>
<span class="c1">#     )</span>
<span class="c1">#     reference_by_record = reference_by_record.sort_values(&quot;raw_reference&quot;)</span>

<span class="c1">#     # -------------------------------------------------------------------------</span>
<span class="c1">#     # optimized for speed</span>
<span class="c1">#     # raw references and list of citting documents:</span>
<span class="c1">#     reference_by_record = reference_by_record.groupby(</span>
<span class="c1">#         [&quot;raw_reference&quot;], as_index=False</span>
<span class="c1">#     ).agg(list)</span>
<span class="c1">#     reference_by_record = reference_by_record.assign(references_record_no=np.nan)</span>
<span class="c1">#     #</span>
<span class="c1">#     references = references.assign(title=references.title.str.lower())</span>
<span class="c1">#     references = references[~references.authors.isna()]</span>

<span class="c1">#     with tqdm(total=len(references), disable=disable_progress_bar) as pbar:</span>
<span class="c1">#         for _, row in references.iterrows():</span>
<span class="c1">#             reference_by_record.loc[</span>
<span class="c1">#                 reference_by_record.raw_reference.str.contains(</span>
<span class="c1">#                     row[&quot;title&quot;], regex=False</span>
<span class="c1">#                 )</span>
<span class="c1">#                 &amp; reference_by_record.raw_reference.str.contains(str(row[&quot;year&quot;]))</span>
<span class="c1">#                 &amp; reference_by_record.raw_reference.str.contains(</span>
<span class="c1">#                     row[&quot;authors&quot;].split(&quot; &quot;)[0].strip()</span>
<span class="c1">#                 ),</span>
<span class="c1">#                 &quot;references_record_no&quot;,</span>
<span class="c1">#             ] = row[&quot;record_no&quot;]</span>
<span class="c1">#             pbar.update(1)</span>

<span class="c1">#     reference_by_record = reference_by_record.dropna()</span>
<span class="c1">#     reference_by_record = reference_by_record.explode(&quot;record_no&quot;)</span>
<span class="c1">#     reference_by_record = reference_by_record[</span>
<span class="c1">#         [&quot;record_no&quot;, &quot;references_record_no&quot;]</span>
<span class="c1">#     ].copy()</span>
<span class="c1">#     reference_by_record = reference_by_record.rename(</span>
<span class="c1">#         columns={&quot;record_no&quot;: &quot;documents_record_no&quot;}</span>
<span class="c1">#     )</span>
<span class="c1">#     reference_by_record = reference_by_record.reset_index(drop=True)</span>
<span class="c1">#     reference_by_record = reference_by_record.dropna()</span>
<span class="c1">#     reference_by_record = reference_by_record.sort_values(</span>
<span class="c1">#         [&quot;documents_record_no&quot;, &quot;references_record_no&quot;]</span>
<span class="c1">#     )</span>

<span class="c1">#     reference_by_record.to_csv(</span>
<span class="c1">#         os.path.join(directory, &quot;processed&quot;, &quot;references_by_document.csv&quot;), index=False</span>
<span class="c1">#     )</span>


<span class="k">def</span> <span class="nf">_create__num_authors__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `num_authors` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">authors</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">num_authors</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">num_authors</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">len</span><span class="p">,</span> <span class="n">na_action</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">num_authors</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">num_authors</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">num_authors</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># def _create__local_citations__column(directory):</span>
<span class="c1">#</span>
<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `local_citations` column\n&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     file_name = os.path.join(directory, &quot;processed&quot;, &quot;_documents.csv&quot;)</span>
<span class="c1">#     documents = pd.read_csv(file_name)</span>
<span class="c1">#</span>
<span class="c1">#     local_references = documents[[&quot;local_references&quot;]]</span>
<span class="c1">#     local_references = local_references.rename(</span>
<span class="c1">#         columns={&quot;local_references&quot;: &quot;local_citations&quot;}</span>
<span class="c1">#     )</span>
<span class="c1">#     local_references = local_references.dropna()</span>
<span class="c1">#</span>
<span class="c1">#     local_references[&quot;local_citations&quot;] = local_references.local_citations.str.split(</span>
<span class="c1">#         &quot;;&quot;</span>
<span class="c1">#     )</span>
<span class="c1">#     local_references = local_references.explode(&quot;local_citations&quot;)</span>
<span class="c1">#     local_references[&quot;local_citations&quot;] = local_references.local_citations.str.strip()</span>
<span class="c1">#</span>
<span class="c1">#     local_references = local_references.groupby(</span>
<span class="c1">#         by=&quot;local_citations&quot;, as_index=True</span>
<span class="c1">#     ).size()</span>
<span class="c1">#     documents[&quot;local_citations&quot;] = 0</span>
<span class="c1">#     documents.index = documents.record_no</span>
<span class="c1">#     documents.loc[local_references.index, &quot;local_citations&quot;] = local_references</span>
<span class="c1">#</span>
<span class="c1">#     documents.to_csv(file_name, sep=&quot;,&quot;, index=False, encoding=&quot;utf-8&quot;)</span>


<span class="c1"># def _create__local_references__column(directory, disable_progress_bar):</span>
<span class="c1">#</span>
<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `local_references` column\n&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     file_name = os.path.join(directory, &quot;processed&quot;, &quot;_documents.csv&quot;)</span>
<span class="c1">#     documents = pd.read_csv(file_name)</span>
<span class="c1">#</span>
<span class="c1">#     # creates a empty list which will be filled with the local references</span>
<span class="c1">#     documents = documents.assign(local_references=[[] for _ in range(len(documents))])</span>
<span class="c1">#</span>
<span class="c1">#     if &quot;global_references&quot; in documents.columns:</span>
<span class="c1">#</span>
<span class="c1">#         #</span>
<span class="c1">#         # Identifies if a document is a local reference using doi</span>
<span class="c1">#         #</span>
<span class="c1">#         with tqdm(total=len(documents.doi), disable=disable_progress_bar) as pbar:</span>
<span class="c1">#             for document_index, doi, global_citations in zip(</span>
<span class="c1">#                 documents.index, documents.doi, documents.global_citations</span>
<span class="c1">#             ):</span>
<span class="c1">#                 if global_citations == 0:</span>
<span class="c1">#                     continue</span>
<span class="c1">#                 if not pd.isna(doi):</span>
<span class="c1">#                     doi = doi.upper()</span>
<span class="c1">#                     for j_index, references in zip(</span>
<span class="c1">#                         documents.index, documents.global_references.tolist()</span>
<span class="c1">#                     ):</span>
<span class="c1">#                         if pd.isna(references) is False and doi in references.upper():</span>
<span class="c1">#                             documents.at[j_index, &quot;local_references&quot;].append(</span>
<span class="c1">#                                 documents.record_no[document_index]</span>
<span class="c1">#                             )</span>
<span class="c1">#                 pbar.update(1)</span>
<span class="c1">#</span>
<span class="c1">#         #</span>
<span class="c1">#         # Identifies if a document is a local reference using the title</span>
<span class="c1">#         #</span>
<span class="c1">#         with tqdm(total=len(documents.title), disable=disable_progress_bar) as pbar:</span>
<span class="c1">#</span>
<span class="c1">#             for (</span>
<span class="c1">#                 document_index,</span>
<span class="c1">#                 document_title,</span>
<span class="c1">#                 document_year,</span>
<span class="c1">#                 document_citations,</span>
<span class="c1">#             ) in zip(</span>
<span class="c1">#                 documents.index,</span>
<span class="c1">#                 documents.title.str.lower(),</span>
<span class="c1">#                 documents.year,</span>
<span class="c1">#                 documents.global_citations,</span>
<span class="c1">#             ):</span>
<span class="c1">#</span>
<span class="c1">#                 if document_citations &gt; 0:</span>
<span class="c1">#</span>
<span class="c1">#                     document_title = documents.title[document_index].lower()</span>
<span class="c1">#                     document_year = documents.year[document_index]</span>
<span class="c1">#</span>
<span class="c1">#                     for j_index, references in zip(</span>
<span class="c1">#                         documents.index, documents.global_references.tolist()</span>
<span class="c1">#                     ):</span>
<span class="c1">#</span>
<span class="c1">#                         if (</span>
<span class="c1">#                             pd.isna(references) is False</span>
<span class="c1">#                             and document_title in references.lower()</span>
<span class="c1">#                         ):</span>
<span class="c1">#</span>
<span class="c1">#                             for reference in references.split(&quot;;&quot;):</span>
<span class="c1">#</span>
<span class="c1">#                                 if (</span>
<span class="c1">#                                     document_title in reference.lower()</span>
<span class="c1">#                                     and str(document_year) in reference</span>
<span class="c1">#                                 ):</span>
<span class="c1">#</span>
<span class="c1">#                                     documents.at[j_index, &quot;local_references&quot;] += [</span>
<span class="c1">#                                         documents.record_no[document_index]</span>
<span class="c1">#                                     ]</span>
<span class="c1">#</span>
<span class="c1">#                 pbar.update(1)</span>
<span class="c1">#</span>
<span class="c1">#         #</span>
<span class="c1">#         # Create a string list of with the local references</span>
<span class="c1">#         #</span>
<span class="c1">#         documents[&quot;local_references&quot;] = documents.local_references.apply(</span>
<span class="c1">#             lambda x: sorted(set(x))</span>
<span class="c1">#         )</span>
<span class="c1">#         documents[&quot;local_references&quot;] = documents.local_references.apply(</span>
<span class="c1">#             lambda x: &quot;; &quot;.join(x) if isinstance(x, list) else x</span>
<span class="c1">#         )</span>
<span class="c1">#</span>
<span class="c1">#     documents.to_csv(file_name, sep=&quot;,&quot;, index=False, encoding=&quot;utf-8&quot;)</span>


<span class="k">def</span> <span class="nf">_create__abstract_csv__file</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
        <span class="s2">&quot;--INFO-- Creating `abstract.csv` file from `documents` database</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="p">)</span>

    <span class="n">documents</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_documents.csv&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="s2">&quot;abstract&quot;</span> <span class="ow">in</span> <span class="n">documents</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>

        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">documents</span><span class="p">[[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;abstract&quot;</span><span class="p">,</span> <span class="s2">&quot;global_citations&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;abstract&quot;</span><span class="p">:</span> <span class="s2">&quot;phrase&quot;</span><span class="p">})</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="n">abstracts</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">))</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="n">abstracts</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">sent_tokenize</span><span class="p">))</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;phrase&quot;</span><span class="p">)</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">phrase</span><span class="o">=</span><span class="n">abstracts</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="p">[</span><span class="n">abstracts</span><span class="o">.</span><span class="n">phrase</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">len</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">line_no</span><span class="o">=</span><span class="n">abstracts</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;article&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">())</span>
        <span class="n">abstracts</span> <span class="o">=</span> <span class="n">abstracts</span><span class="p">[[</span><span class="s2">&quot;article&quot;</span><span class="p">,</span> <span class="s2">&quot;line_no&quot;</span><span class="p">,</span> <span class="s2">&quot;phrase&quot;</span><span class="p">,</span> <span class="s2">&quot;global_citations&quot;</span><span class="p">]]</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;abstracts.csv&quot;</span><span class="p">)</span>
        <span class="n">abstracts</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__global_references__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `global_references` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;global_references&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">global_references</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;https://doi.org/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">global_references</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                    <span class="s2">&quot;http://dx.doi.org/&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create__num_global_references__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `num_global_references` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;global_references&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">num_global_references</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">global_references</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">num_global_references</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">num_global_references</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create__bradford__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `bradford` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_documents.csv&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>

    <span class="n">indicators</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;source_title&quot;</span><span class="p">,</span> <span class="s2">&quot;global_citations&quot;</span><span class="p">]]</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">num_documents</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;source_title&quot;</span><span class="p">],</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span>
        <span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;num_documents&quot;</span><span class="p">,</span> <span class="s2">&quot;global_citations&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
        <span class="n">cum_num_documents</span><span class="o">=</span><span class="n">indicators</span><span class="p">[</span><span class="s2">&quot;num_documents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="n">num_documents</span> <span class="o">=</span> <span class="n">indicators</span><span class="p">[</span><span class="s2">&quot;num_documents&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">indicators</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">zone</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">indicators</span><span class="o">.</span><span class="n">zone</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">indicators</span><span class="o">.</span><span class="n">cum_num_documents</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_documents</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">2</span>
    <span class="p">)</span>
    <span class="n">indicators</span><span class="o">.</span><span class="n">zone</span> <span class="o">=</span> <span class="n">indicators</span><span class="o">.</span><span class="n">zone</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
        <span class="n">indicators</span><span class="o">.</span><span class="n">cum_num_documents</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_documents</span> <span class="o">/</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">1</span>
    <span class="p">)</span>
    <span class="n">source2zone</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">indicators</span><span class="o">.</span><span class="n">source_title</span><span class="p">,</span> <span class="n">indicators</span><span class="o">.</span><span class="n">zone</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">bradford</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;source_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">source2zone</span><span class="p">))</span>
    <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="c1"># def _create__countries__column(directory):</span>
<span class="c1">#</span>
<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `countries` column\n&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
<span class="c1">#     for file in files:</span>
<span class="c1">#         data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>
<span class="c1">#         if &quot;raw_countries&quot; in data.columns:</span>
<span class="c1">#             data = data.assign(countries=data[&quot;raw_countries&quot;].str.split(&quot;;&quot;))</span>
<span class="c1">#             data = data.assign(</span>
<span class="c1">#                 countries=data[&quot;countries&quot;].map(</span>
<span class="c1">#                     lambda x: &quot;; &quot;.join(set(x)) if isinstance(x, list) else x</span>
<span class="c1">#                 )</span>
<span class="c1">#             )</span>
<span class="c1">#</span>
<span class="c1">#         data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>


<span class="c1"># def _create__coutry_1st_autor__column(directory):</span>
<span class="c1">#</span>
<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `country_1st_author` column\n&quot;)</span>
<span class="c1">#</span>
<span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
<span class="c1">#     for file in files:</span>
<span class="c1">#         data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>
<span class="c1">#         if &quot;raw_countries&quot; in data.columns:</span>
<span class="c1">#             data = data.assign(</span>
<span class="c1">#                 country_1st_author=data[&quot;raw_countries&quot;].str.split(&quot;;&quot;).str[0]</span>
<span class="c1">#             )</span>
<span class="c1">#         data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>


<span class="c1"># def _create__raw_countries__column(directory):</span>
<span class="c1">#     # sys.stdout.write(&quot;--INFO-- Creating `raw_countries` column\n&quot;)</span>
<span class="c1">#     extract_country(</span>
<span class="c1">#         directory=directory,</span>
<span class="c1">#         input_col=&quot;affiliations&quot;,</span>
<span class="c1">#         output_col=&quot;raw_countries&quot;,</span>
<span class="c1">#     )</span>


<span class="k">def</span> <span class="nf">_extract_keywords_roots_from_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">keywords_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;raw_author_keywords&quot;</span><span class="p">,</span> <span class="s2">&quot;raw_index_keywords&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">keywords_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keywords_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">keywords_list</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">explode</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.+\]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\(.+\)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;&amp;&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># list of single words</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">PorterStemmer</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">stem</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="nb">sorted</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">keywords_list</span>


<span class="k">def</span> <span class="nf">_extract_keywords_from_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;raw_index_keywords&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">keywords_list</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;raw_author_keywords&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">keywords_list</span> <span class="o">+=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;keyword&quot;</span><span class="p">:</span> <span class="n">keywords_list</span><span class="p">})</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="n">keywords_list</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;keyword&quot;</span><span class="p">)</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">keyword</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
    <span class="n">keywords_list</span> <span class="o">=</span> <span class="n">keywords_list</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">keywords_list</span>


<span class="c1"># def _select_compound_keywords(keywords_list):</span>
<span class="c1">#     keywords_list = keywords_list.to_frame()</span>
<span class="c1">#     keywords_list = keywords_list.assign(</span>
<span class="c1">#         is_compound=keywords_list.keyword.str.contains(&quot; &quot;)</span>
<span class="c1">#     )</span>
<span class="c1">#     keywords_list = keywords_list[keywords_list.is_compound]</span>
<span class="c1">#     keywords_list = keywords_list[[&quot;keyword&quot;]]</span>
<span class="c1">#     return keywords_list</span>


<span class="c1"># def _load_nltk_stopwords():</span>
<span class="c1">#     module_path = os.path.dirname(__file__)</span>
<span class="c1">#     file_path = os.path.join(module_path, &quot;files/nltk_stopwords.txt&quot;)</span>
<span class="c1">#     with open(file_path, &quot;r&quot;, encoding=&quot;utf-8&quot;) as file:</span>
<span class="c1">#         nltk_stopwords = [line.strip() for line in file]</span>
<span class="c1">#     return nltk_stopwords</span>


<span class="c1"># def _create__raw_title_words__column(directory):</span>

<span class="c1">#     keywords = _extract_keywords_from_database_files(directory)</span>
<span class="c1">#     keywords = keywords.str.replace(r&quot;\(.+\)&quot;, &quot;&quot;, regex=True)</span>
<span class="c1">#     keywords = keywords.str.replace(r&quot;\(.+$&quot;, &quot;&quot;, regex=True)</span>
<span class="c1">#     keywords = keywords.str.replace(r&quot;^.+\)&quot;, &quot;&quot;, regex=True)</span>
<span class="c1">#     keywords = keywords.str.replace(&quot;  &quot;, &quot; &quot;)</span>
<span class="c1">#     keywords = keywords.str.replace(&quot;  &quot;, &quot; &quot;)</span>
<span class="c1">#     keywords = keywords.str.replace(&quot;  &quot;, &quot; &quot;)</span>
<span class="c1">#     keywords = keywords.dropna()</span>
<span class="c1">#     keywords = keywords.to_list()</span>

<span class="c1">#     #</span>
<span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
<span class="c1">#     for file in files:</span>

<span class="c1">#         if &quot;_documents.csv&quot; not in file:</span>
<span class="c1">#             continue</span>

<span class="c1">#         data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>

<span class="c1">#         sys.stdout.write(f&quot;--INFO-- Creating `raw_title_words` column in {file}\n&quot;)</span>

<span class="c1">#         if &quot;title&quot; not in data.columns:</span>
<span class="c1">#             continue</span>

<span class="c1">#         title = data[&quot;title&quot;].str.lower()</span>

<span class="c1">#         data[&quot;raw_title_words&quot;] = [[] for _ in range(len(data))]</span>
<span class="c1">#         for keyword in keywords:</span>

<span class="c1">#             keyword = r&quot;\b(&quot; + keyword + r&quot;)\b&quot;</span>
<span class="c1">#             found = title.str.extract(keyword, expand=False)</span>
<span class="c1">#             found = found.fillna(&quot;&quot;)</span>
<span class="c1">#             found = found.map(lambda x: [x])</span>
<span class="c1">#             data[&quot;raw_title_words&quot;] += found</span>

<span class="c1">#         data[&quot;raw_title_words&quot;] = data[&quot;raw_title_words&quot;].map(</span>
<span class="c1">#             lambda x: sorted(set([y.strip() for y in x if y != &quot;&quot;]))</span>
<span class="c1">#         )</span>
<span class="c1">#         data[&quot;raw_title_words&quot;] = data[&quot;raw_title_words&quot;].map(</span>
<span class="c1">#             lambda x: pd.NA if len(x) == 0 else x</span>
<span class="c1">#         )</span>
<span class="c1">#         data[&quot;raw_title_words&quot;] = data[&quot;raw_title_words&quot;].str.join(&quot;; &quot;)</span>

<span class="c1">#         #</span>
<span class="c1">#         data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>


<span class="c1"># def _create__record_no__column(directory):</span>

<span class="c1">#     # sys.stdout.write(&quot;--INFO-- Creating `record_no` column\n&quot;)</span>

<span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
<span class="c1">#     for file in files:</span>
<span class="c1">#         data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>
<span class="c1">#         #</span>
<span class="c1">#         data = data.assign(</span>
<span class="c1">#             record_no=data.sort_values(&quot;global_citations&quot;, ascending=False)</span>
<span class="c1">#             .groupby(&quot;year&quot;)</span>
<span class="c1">#             .cumcount()</span>
<span class="c1">#         )</span>
<span class="c1">#         data = data.assign(record_no=data.record_no.map(lambda x: str(x).zfill(4)))</span>
<span class="c1">#         data = data.assign(record_no=data.year.astype(str) + &quot;-&quot; + data.record_no)</span>
<span class="c1">#         #</span>
<span class="c1">#         data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>

<span class="c1">#     return data</span>


<span class="c1"># def _create__article__column(directory):</span>

<span class="c1">#     # sys.stdout.write(&quot;--INFO-- Creating `Article` column\n&quot;)</span>

<span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
<span class="c1">#     for file in files:</span>
<span class="c1">#         data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>
<span class="c1">#         #</span>
<span class="c1">#         wos_ref = data.authors.map(</span>
<span class="c1">#             lambda x: x.split(&quot;; &quot;)[0].strip() if not pd.isna(x) else &quot;[anonymous]&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#         wos_ref = wos_ref + data.authors.map(</span>
<span class="c1">#             lambda x: (&quot; et al&quot; if len(x.split(&quot;; &quot;)) &gt; 0 else &quot;&quot;)</span>
<span class="c1">#             if not pd.isna(x)</span>
<span class="c1">#             else &quot;&quot;</span>
<span class="c1">#         )</span>
<span class="c1">#         wos_ref = wos_ref + &quot;, &quot; + data.year.map(str)</span>
<span class="c1">#         wos_ref = wos_ref + &quot;, &quot; + data.source_abbr</span>
<span class="c1">#         data[&quot;Article&quot;] = wos_ref.copy()</span>
<span class="c1">#         #</span>

<span class="c1">#         data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>


<span class="c1"># def _create_filter_file(directory):</span>

<span class="c1">#     sys.stdout.write(&quot;--INFO-- Creating `filter.yaml` file\n&quot;)</span>

<span class="c1">#     file_name = os.path.join(directory, &quot;processed/_documents.csv&quot;)</span>
<span class="c1">#     documents = pd.read_csv(file_name, encoding=&quot;utf-8&quot;)</span>

<span class="c1">#     filter_ = {}</span>
<span class="c1">#     filter_[&quot;first_year&quot;] = int(documents.year.min())</span>
<span class="c1">#     filter_[&quot;last_year&quot;] = int(documents.year.max())</span>
<span class="c1">#     filter_[&quot;min_citations&quot;] = 0</span>
<span class="c1">#     filter_[&quot;max_citations&quot;] = int(documents.global_citations.max())</span>
<span class="c1">#     filter_[&quot;bradford&quot;] = 3</span>

<span class="c1">#     document_types = documents.document_type.dropna().unique()</span>
<span class="c1">#     for document_type in document_types:</span>
<span class="c1">#         document_type = document_type.lower()</span>
<span class="c1">#         document_type = document_type.replace(&quot; &quot;, &quot;_&quot;)</span>
<span class="c1">#         filter_[str(document_type)] = True</span>

<span class="c1">#     yaml_filename = os.path.join(directory, &quot;processed&quot;, &quot;filter.yaml&quot;)</span>
<span class="c1">#     with open(yaml_filename, &quot;wt&quot;, encoding=&quot;utf-8&quot;) as yaml_file:</span>
<span class="c1">#         yaml.dump(filter_, yaml_file, sort_keys=True)</span>


<span class="k">def</span> <span class="nf">_complete__source_abbr__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Complete `source_abbr` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">name2iso</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>

    <span class="c1"># builds the dictionary</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;source_abbr&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;source_name&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">current_name2iso</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">name</span><span class="p">:</span> <span class="n">abbr</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">abbr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">source_name</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="ow">and</span> <span class="n">abbr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
            <span class="p">}</span>
            <span class="n">name2iso</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">name2iso</span><span class="p">,</span> <span class="o">**</span><span class="n">current_name2iso</span><span class="p">}</span>

    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;source_abbr&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="s2">&quot;source_name&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">source_name</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">name2iso</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span>
                <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; JOUNAL &quot;</span><span class="p">,</span> <span class="s2">&quot; J &quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; AND &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; IN &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; OF &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; ON &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; THE &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="p">[:</span><span class="mi">29</span><span class="p">]</span>

        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create__authors__column</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">):</span>
    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">load_authors_names</span><span class="p">():</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)[[</span><span class="s2">&quot;raw_authors&quot;</span><span class="p">,</span> <span class="s2">&quot;authors_id&quot;</span><span class="p">]]</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span>
        <span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="c1">#</span>
    <span class="k">def</span> <span class="nf">build_dict_names</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">authors_and_ids</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_id</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">))</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">explode</span><span class="p">(</span><span class="s2">&quot;authors_and_ids&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;authors_and_ids&quot;</span><span class="p">]]</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">data</span><span class="p">[</span><span class="s2">&quot;author_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_and_ids</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;authors_and_ids&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;author&quot;</span><span class="p">])</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">counter</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">groupby</span><span class="p">([</span><span class="s2">&quot;author&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">cumcount</span><span class="p">())</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">author</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">data</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">author</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;/0&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">author_id2name</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">author_id</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">author</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">author_id2name</span>

    <span class="c1">#</span>
    <span class="c1"># def repair_names__(author_id2name, disable_progress_bar):</span>
    <span class="c1">#     files = list(glob.glob(os.path.join(directory, &quot;processed/_*.csv&quot;)))</span>
    <span class="c1">#     total_items = len(files) * len(author_id2name)</span>
    <span class="c1">#     with tqdm(total=total_items, disable=disable_progress_bar) as pbar:</span>
    <span class="c1">#         for file in files:</span>
    <span class="c1">#             data = pd.read_csv(file, encoding=&quot;utf-8&quot;)</span>
    <span class="c1">#             data = data.assign(authors=data.authors_id.copy())</span>
    <span class="c1">#             data = data.assign(authors=data.authors.str.replace(&quot;;&quot;, &quot;; &quot;))</span>
    <span class="c1">#             for author_id, author in author_id2name.items():</span>
    <span class="c1">#                 data = data.assign(</span>
    <span class="c1">#                     authors=data.authors.str.replace(author_id, author)</span>
    <span class="c1">#                 )</span>
    <span class="c1">#                 pbar.update(1)</span>
    <span class="c1">#             data.to_csv(file, sep=&quot;,&quot;, encoding=&quot;utf-8&quot;, index=False)</span>
    <span class="c1">#</span>

    <span class="k">def</span> <span class="nf">repair_names</span><span class="p">(</span><span class="n">author_id2name</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">):</span>
        <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
        <span class="n">total_items</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">authors</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">authors_id</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[</span><span class="n">author_id2name</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1">#</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Creating `authors` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">load_authors_names</span><span class="p">()</span>
    <span class="n">author_id2name</span> <span class="o">=</span> <span class="n">build_dict_names</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">repair_names</span><span class="p">(</span><span class="n">author_id2name</span><span class="p">,</span> <span class="n">disable_progress_bar</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__source_abbr__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `source_abbr` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;source_abbr&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_abbr</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__raw_index_keywords__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `raw_index_keywords` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;raw_index_keywords&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__raw_author_keywords__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `raw_author_keywords` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;raw_author_keywords&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">([</span><span class="n">y</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">])</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>

        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__raw_keywords__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `raw_keywords` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;raw_author_keywords&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
            <span class="ow">and</span> <span class="s2">&quot;raw_index_keywords&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">):</span>
            <span class="n">raw_author_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
            <span class="n">raw_author_keywords</span> <span class="o">=</span> <span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">raw_index_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;; &quot;</span><span class="p">)</span>
            <span class="n">raw_index_keywords</span> <span class="o">=</span> <span class="n">raw_index_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">[]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_keywords&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">raw_author_keywords</span> <span class="o">+</span> <span class="n">raw_index_keywords</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="p">[]</span> <span class="k">else</span> <span class="n">x</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_keywords</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_author_keywords</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__global_citations__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `global_citations` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;global_citations&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">global_citations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">global_citations</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">global_citations</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">global_citations</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__raw_authors__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `raw_authors` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;raw_authors&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;[No author name available]&quot;</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">raw_authors</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__title__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `title` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;title&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\[.*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">title</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__abstract__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `abstract` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;abstract&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;abstract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;abstract&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">abstract</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span>
                <span class="n">data</span><span class="o">.</span><span class="n">abstract</span> <span class="o">==</span> <span class="s2">&quot;[no abstract available]&quot;</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__authors_id__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `authors_id` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;document_type&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_id</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;;$&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;authors_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">authors_id</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="s2">&quot;[No author id available]&quot;</span> <span class="k">else</span> <span class="n">x</span>
            <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__document_type__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `document_type` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;document_type&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;document_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">document_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;document_type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">document_type</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__source_name__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `source_name` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;source_name&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">source_name</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">source_name</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[^\w\s]&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__issn__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `issn` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;issn&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">issn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">issn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">issn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">issn</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">issn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">issn</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__isbn__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `isbn` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;isbn&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isbn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isbn</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">isbn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">isbn</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__eissn__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `eissn` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;eissn&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">eissn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">eissn</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">eissn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">eissn</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">regex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">data</span><span class="o">.</span><span class="n">eissn</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">eissn</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_process__doi__column</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Processing `doi` column</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;doi&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">doi</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">doi</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_accents_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Removing accents in database files</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># cols = data.select_dtypes(include=[np.object]).columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s2">&quot;NFKD&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_remove_stranger_chars_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Removing stranger chars in database files</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="c1">#</span>
        <span class="c1"># cols = data.select_dtypes(include=[np.object]).columns</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;object&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;lpar;&quot;</span><span class="p">,</span> <span class="s2">&quot;(&quot;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;rpar;&quot;</span><span class="p">,</span> <span class="s2">&quot;)&quot;</span><span class="p">))</span>
        <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&amp;colon;&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>
        <span class="c1">#</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_create_ignore_file</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;stopwords.txt&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_drop_na_columns_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Dropping NA columns in database files</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_format_columns_names_in_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Format column names in database files.&quot;&quot;&quot;</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Formating column names in database files</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span>
                <span class="n">col</span><span class="p">:</span> <span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_apply_scopus2tags_to_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;--INFO-- Applying scopus tags to database files</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">scopus2tags</span> <span class="o">=</span> <span class="n">_load_scopus2tags_as_dict</span><span class="p">()</span>
    <span class="n">files</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed/_*.csv&quot;</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">scopus2tags</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_scopus2tags_as_dict</span><span class="p">():</span>
    <span class="n">module_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">module_path</span><span class="p">,</span> <span class="s2">&quot;../../_files/scopus2tags.csv&quot;</span><span class="p">)</span>
    <span class="n">names_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="n">name</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">tag</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">names_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>

    <span class="k">return</span> <span class="n">names_dict</span>


<span class="k">def</span> <span class="nf">_create_database_files</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">))</span>
    <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">folders</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">))]</span>
    <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">_concat_raw_csv_files</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span> <span class="n">folder</span><span class="p">))</span>
        <span class="n">data</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">folder</span> <span class="o">+</span> <span class="s2">&quot;.csv&quot;</span><span class="p">),</span>
            <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>
            <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_concat_raw_csv_files</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">quiet</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load raw csv files in a directory.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">quiet</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;--INFO-- Concatenating raw files in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">/</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No CSV files found in </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file_name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file_name</span><span class="p">),</span>
                <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
                <span class="n">on_bad_lines</span><span class="o">=</span><span class="s2">&quot;skip&quot;</span><span class="p">,</span>
                <span class="c1"># warn_bad_lines=True,</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">data</span>


<span class="k">def</span> <span class="nf">_create_working_directories</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;processed&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;reports&quot;</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="s2">&quot;reports&quot;</span><span class="p">))</span>


<span class="c1"># def _process__affiliations__column(documents):</span>
<span class="c1">#     if &quot;affiliations&quot; in documents.columns:</span>
<span class="c1">#         documents = documents.copy()</span>
<span class="c1">#         documents[&quot;countries&quot;] = map_(documents, &quot;affiliations&quot;, extract_country)</span>

<span class="c1">#         documents[&quot;countries&quot;] = documents.countries.map(</span>
<span class="c1">#             lambda w: &quot;; &quot;.join(set(w.split(&quot;; &quot;))) if isinstance(w, str) else w</span>
<span class="c1">#         )</span>
<span class="c1">#     return documents</span>


<span class="c1"># ----&lt; Local references &gt;-----------------------------------------------------</span>


<span class="c1"># def _make_documents(scopus, cited_by, references):</span>
<span class="c1">#</span>
<span class="c1">#     links_scopus = scopus.Link.copy()</span>
<span class="c1">#     links_cited_by = cited_by.Link.copy()</span>
<span class="c1">#     links_references = references.Link.copy()</span>
<span class="c1">#</span>
<span class="c1">#     links_cited_by_unique = set(links_cited_by) - set(links_scopus)</span>
<span class="c1">#     links_references_unique = set(links_references) - set(links_scopus)</span>
<span class="c1">#     links_cited_by_common = set(links_scopus) &amp; set(links_cited_by)</span>
<span class="c1">#     links_references_common = set(links_scopus) &amp; set(links_references)</span>
<span class="c1">#</span>
<span class="c1">#     # citing documents not in the main collection</span>
<span class="c1">#     cited_by.index = cited_by.Link</span>
<span class="c1">#     cited_by = cited_by.loc[links_cited_by_unique, :]</span>
<span class="c1">#     cited_by[&quot;main_group&quot;] = False</span>
<span class="c1">#     cited_by[&quot;citing_group&quot;] = True</span>
<span class="c1">#     cited_by[&quot;references_group&quot;] = False</span>
<span class="c1">#</span>
<span class="c1">#     # references not in the main collection</span>
<span class="c1">#     references.index = references.Link</span>
<span class="c1">#     references = references.loc[links_references_unique, :]</span>
<span class="c1">#     references[&quot;main_group&quot;] = False</span>
<span class="c1">#     references[&quot;citing_group&quot;] = False</span>
<span class="c1">#     references[&quot;references_group&quot;] = True</span>
<span class="c1">#     references.loc[:, &quot;References&quot;] = np.nan</span>
<span class="c1">#</span>
<span class="c1">#     scopus.index = scopus.Link</span>
<span class="c1">#     scopus[&quot;main_group&quot;] = True</span>
<span class="c1">#     scopus[&quot;citing_group&quot;] = False</span>
<span class="c1">#     scopus[&quot;references_group&quot;] = False</span>
<span class="c1">#     scopus.loc[links_cited_by_common, &quot;citing_group&quot;] = True</span>
<span class="c1">#     scopus.loc[links_references_common, &quot;references_group&quot;] = True</span>
<span class="c1">#</span>
<span class="c1">#     documents = pd.concat(</span>
<span class="c1">#         [</span>
<span class="c1">#             scopus,</span>
<span class="c1">#             cited_by,</span>
<span class="c1">#             references,</span>
<span class="c1">#         ],</span>
<span class="c1">#         ignore_index=True,</span>
<span class="c1">#     )</span>
<span class="c1">#</span>
<span class="c1">#     documents = documents.reset_index(drop=True)</span>
<span class="c1">#</span>
<span class="c1">#     documents[&quot;main_group&quot;] = documents.main_group.astype(bool)</span>
<span class="c1">#     documents[&quot;citing_group&quot;] = documents.citing_group.astype(bool)</span>
<span class="c1">#     documents[&quot;references_group&quot;] = documents.references_group.astype(bool)</span>
<span class="c1">#</span>
<span class="c1">#     return documents</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>